<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Timetable</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-image 1s ease-in-out, background-color 1s ease-in-out, color 0.3s;
            background-size: cover;
            background-position: center;
        }
        #weather-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        .themed-bg {
             background-color: rgba(255, 255, 255, 0.7);
             backdrop-filter: blur(10px);
             -webkit-backdrop-filter: blur(10px);
             border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .dark .themed-bg {
            background-color: rgba(26, 32, 44, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        header h1, header p {
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
        }
        .dark header h1, .dark header p {
             text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }
        .modal { transition: opacity 0.25s ease; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .day-btn.active {
            background-color: #3B82F6;
            color: white;
            border-color: #3B82F6;
        }

        /* --- Weather & Time Based Themes --- */
        .weather-clear-day { background-image: linear-gradient(to top, #a1c4fd 0%, #c2e9fb 100%); }
        .weather-clear-night { background-image: linear-gradient(to top, #020111 0%, #3a3a52 100%); }
        .weather-cloudy { background-image: linear-gradient(to top, #d3d3d3 0%, #e9e9e9 100%); }
        .weather-rain-bg { background-image: linear-gradient(to top, #4b79a1 0%, #283e51 100%); }
        .weather-snow { background-image: linear-gradient(to top, #e6e9f0 0%, #eef1f5 100%); }
        .weather-haze-bg { background-image: linear-gradient(to top, #bdc3c7 0%, #2c3e50 100%); }
        .weather-default { background-color: #f3f4f6; }
        .dark.weather-default { background-color: #1a202c; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-gray-100">
    <canvas id="weather-canvas"></canvas>
    <!-- Welcome Page -->
    <div id="welcome-page" class="min-h-screen flex items-center justify-center p-4">
        <div class="max-w-md w-full themed-bg p-8 rounded-xl shadow-lg">
            <h2 class="text-3xl font-bold text-center text-gray-800 dark:text-white">Welcome!</h2>
            <p class="text-center text-gray-600 dark:text-gray-300 mt-2 mb-6">What should we call you?</p>
            <form id="name-form">
                <div class="space-y-4">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Your Name</label>
                        <input type="text" id="name" required class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <button type="submit" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                    Continue
                </button>
            </form>
        </div>
    </div>

    <!-- Main App Page -->
    <div id="app-page" class="hidden container mx-auto p-4 sm:p-6 md:p-8 max-w-4xl relative">
        <header class="text-center mb-8">
            <h1 id="greeting-header" class="text-3xl sm:text-4xl font-bold text-gray-800 dark:text-white">Live Timetable</h1>
            <p class="text-lg text-gray-600 dark:text-gray-300 mt-2">Your personal class schedule, live.</p>
        </header>

        <!-- Dark Mode Toggle -->
        <div class="absolute top-4 right-4">
            <button id="dark-mode-toggle" class="p-2 rounded-full bg-white/50 dark:bg-gray-700/50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                <svg id="sun-icon" class="w-6 h-6 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M12 12a5 5 0 100-10 5 5 0 000 10z"></path></svg>
                <svg id="moon-icon" class="w-6 h-6 text-gray-200 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
        </div>

        <main>
            <!-- Current Status Display -->
            <div id="status-container" class="themed-bg rounded-xl shadow-lg p-6 mb-8 text-center">
                <p class="text-lg text-gray-600 dark:text-gray-400 mb-2" id="current-time-display">Loading time...</p>
                <h2 class="text-3xl font-semibold text-gray-800 dark:text-white" id="current-class-display">Checking your schedule...</h2>
                <button id="study-tip-btn" class="hidden mt-4 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                    ✨ Get Study Tip
                </button>
            </div>
            
            <!-- Daily Schedule Display -->
            <div class="themed-bg rounded-xl shadow-lg p-6 mb-8">
                <div id="day-selector" class="flex flex-wrap justify-center gap-2 mb-4">
                    <!-- Day buttons will be injected here -->
                </div>
                <div id="daily-schedule-display">
                    <p class="text-center text-gray-500 dark:text-gray-400">Select a day to see the schedule.</p>
                </div>
            </div>

            <!-- Timetable Input Section -->
            <div class="themed-bg rounded-xl shadow-lg p-6 mb-8">
                <h3 class="text-2xl font-semibold mb-4 text-gray-800 dark:text-white">Edit Full Timetable</h3>
                <p class="text-gray-600 dark:text-gray-400 mb-4">
                    Format: <code class="bg-gray-200 dark:bg-gray-700 p-1 rounded-md text-sm">Day, Start, End, Subject, Room</code>
                </p>
                <textarea id="timetable-input" class="w-full h-48 p-3 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Monday, 09:00, 10:00, Mathematics, C-101..."></textarea>
                <button id="save-timetable" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                    Save Timetable
                </button>
                 <p id="save-confirm" class="text-green-500 text-center mt-2 opacity-0 transition-opacity duration-300">Timetable saved successfully!</p>
            </div>
            
            <!-- Notifications Card -->
            <div class="themed-bg rounded-xl shadow-lg p-4 mb-8 flex items-center justify-between">
                <p class="text-gray-700 dark:text-gray-300">Enable notifications for class starts.</p>
                <button id="notify-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
                </button>
            </div>
        </main>
    </div>
    
    <!-- Study Tip Modal -->
    <div id="study-tip-modal" class="modal pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center opacity-0">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white dark:bg-gray-800 w-11/12 md:max-w-md mx-auto rounded-xl shadow-lg z-50 overflow-y-auto">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3">
                    <p class="text-2xl font-bold text-gray-800 dark:text-white">✨ Smart Study Tip</p>
                    <button id="modal-close-btn" class="cursor-pointer z-50">
                        <svg class="fill-current text-black dark:text-white" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18"><path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path></svg>
                    </button>
                </div>
                <div id="modal-body" class="text-gray-700 dark:text-gray-300">
                    <div class="loader mx-auto my-4"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const welcomePage = document.getElementById('welcome-page');
        const appPage = document.getElementById('app-page');
        const nameForm = document.getElementById('name-form');
        const nameInput = document.getElementById('name');
        const greetingHeader = document.getElementById('greeting-header');
        const currentTimeDisplay = document.getElementById('current-time-display');
        const currentClassDisplay = document.getElementById('current-class-display');
        const timetableInput = document.getElementById('timetable-input');
        const saveTimetableBtn = document.getElementById('save-timetable');
        const saveConfirm = document.getElementById('save-confirm');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const sunIcon = document.getElementById('sun-icon');
        const moonIcon = document.getElementById('moon-icon');
        const weatherCanvas = document.getElementById('weather-canvas');
        const studyTipBtn = document.getElementById('study-tip-btn');
        const studyTipModal = document.getElementById('study-tip-modal');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalBody = document.getElementById('modal-body');
        const daySelector = document.getElementById('day-selector');
        const dailyScheduleDisplay = document.getElementById('daily-schedule-display');
        const notifyBtn = document.getElementById('notify-btn');
        const ctx = weatherCanvas.getContext('2d');

        const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        let particles = [];
        let animationFrameId;
        let currentAnimation = null;
        let currentClass = null;
        let lastNotifiedClass = null;

        // --- Weather Animations ---
        function setupCanvas() { weatherCanvas.width = window.innerWidth; weatherCanvas.height = window.innerHeight; particles = []; }
        function animate() { ctx.clearRect(0, 0, weatherCanvas.width, weatherCanvas.height); particles.forEach((p, index) => { p.update(); p.draw(); if (p.isFinished && p.isFinished()) { particles.splice(index, 1); } }); animationFrameId = requestAnimationFrame(animate); }
        function startAnimation(type) { stopAnimation(); currentAnimation = type; setupCanvas(); switch(type) { case 'rain': for (let i = 0; i < 500; i++) particles.push(new RainDrop()); break; case 'snow': for (let i = 0; i < 200; i++) particles.push(new Snowflake()); break; case 'clear-day': for (let i = 0; i < 15; i++) particles.push(new SunRay()); break; case 'clear-night': for (let i = 0; i < 200; i++) particles.push(new Star()); if (Math.random() < 0.1) particles.push(new ShootingStar()); break; case 'cloudy': for (let i = 0; i < 25; i++) particles.push(new Cloud()); break; case 'haze': for (let i = 0; i < 100; i++) particles.push(new HazeParticle()); break; } if (particles.length > 0) { animate(); } }
        function stopAnimation() { if (animationFrameId) { cancelAnimationFrame(animationFrameId); animationFrameId = null; } currentAnimation = null; particles = []; ctx.clearRect(0, 0, weatherCanvas.width, weatherCanvas.height); }
        class RainDrop { constructor() { this.z = Math.random() * 2 + 1; this.x = Math.random() * weatherCanvas.width; this.y = Math.random() * -weatherCanvas.height; this.length = 10 * this.z; this.speed = 4 * this.z; this.opacity = 0.3 + 0.4 * this.z; } update() { this.y += this.speed; if (this.y > weatherCanvas.height) { this.y = 0 - this.length; this.x = Math.random() * weatherCanvas.width; } } draw() { ctx.strokeStyle = `rgba(174,194,224,${this.opacity})`; ctx.lineWidth = 1 * this.z; ctx.lineCap = 'round'; ctx.beginPath(); ctx.moveTo(this.x, this.y); ctx.lineTo(this.x, this.y + this.length); ctx.stroke(); } }
        class Snowflake { constructor() { this.z = Math.random() * 2 + 1; this.x = Math.random() * weatherCanvas.width; this.y = Math.random() * -weatherCanvas.height; this.radius = 1 * this.z; this.speed = 0.5 * this.z; this.drift = Math.random() * 2 - 1; } update() { this.y += this.speed; this.x += this.drift; if (this.y > weatherCanvas.height) { this.x = Math.random() * weatherCanvas.width; this.y = 0 - this.radius; } } draw() { ctx.fillStyle = `rgba(255, 255, 255, ${0.6 * this.z})`; ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2); ctx.fill(); } }
        class Star { constructor() { this.x = Math.random() * weatherCanvas.width; this.y = Math.random() * weatherCanvas.height; this.radius = Math.random() * 1.2; this.baseAlpha = Math.random() * 0.5 + 0.3; this.alpha = this.baseAlpha; this.twinkleSpeed = Math.random() * 0.005; this.twinkleDirection = 1; } update() { this.alpha += this.twinkleSpeed * this.twinkleDirection; if (this.alpha > this.baseAlpha + 0.2 || this.alpha < this.baseAlpha - 0.2) { this.twinkleDirection *= -1; } } draw() { ctx.fillStyle = `rgba(255, 255, 255, ${this.alpha})`; ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2); ctx.fill(); } }
        class ShootingStar { constructor() { this.x = Math.random() * weatherCanvas.width; this.y = Math.random() * weatherCanvas.height / 2; this.len = Math.random() * 80 + 10; this.speed = Math.random() * 10 + 6; this.size = Math.random() * 1 + 0.1; this.opacity = 1; } update() { this.x += this.speed; this.y += this.speed / 2; this.opacity -= 0.02; } draw() { ctx.strokeStyle = `rgba(255, 255, 255, ${this.opacity})`; ctx.lineWidth = this.size; ctx.beginPath(); ctx.moveTo(this.x, this.y); ctx.lineTo(this.x - this.len, this.y - this.len / 2); ctx.stroke(); } isFinished() { return this.opacity <= 0; } }
        class Cloud { constructor() { this.x = Math.random() * weatherCanvas.width; this.y = Math.random() * (weatherCanvas.height / 3); this.speed = Math.random() * 0.2 + 0.1; this.radius = Math.random() * 60 + 50; this.opacity = Math.random() * 0.2 + 0.1; } update() { this.x += this.speed; if (this.x > weatherCanvas.width + this.radius * 2) { this.x = -this.radius * 2; } } draw() { ctx.fillStyle = `rgba(255, 255, 255, ${this.opacity})`; ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2); ctx.arc(this.x + 50, this.y, this.radius * 0.8, 0, Math.PI * 2); ctx.arc(this.x - 50, this.y, this.radius * 0.8, 0, Math.PI * 2); ctx.fill(); } }
        class SunRay { constructor() { this.x = 100; this.y = 100; this.angle = Math.random() * Math.PI * 2; this.speed = (Math.random() - 0.5) * 0.002; this.length = weatherCanvas.width; this.opacity = Math.random() * 0.05 + 0.02; } update() { this.angle += this.speed; } draw() { ctx.strokeStyle = `rgba(255, 255, 220, ${this.opacity})`; ctx.lineWidth = Math.random() * 100 + 50; ctx.beginPath(); ctx.moveTo(this.x, this.y); ctx.lineTo(this.x + Math.cos(this.angle) * this.length, this.y + Math.sin(this.angle) * this.length); ctx.stroke(); } }
        class HazeParticle { constructor() { this.x = Math.random() * weatherCanvas.width; this.y = Math.random() * weatherCanvas.height; this.radius = Math.random() * 40 + 20; this.speed = Math.random() * 0.1 + 0.05; this.opacity = Math.random() * 0.05 + 0.02; } update() { this.x += this.speed; if (this.x > weatherCanvas.width + this.radius) { this.x = -this.radius; } } draw() { ctx.fillStyle = `rgba(200, 200, 200, ${this.opacity})`; ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2); ctx.fill(); } }
        window.addEventListener('resize', setupCanvas);

        async function fetchWeatherAndApplyTheme() {
            const lat = 28.5150; const lon = 77.3713;
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=weather_code`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                applyWeatherTheme(data.current.weather_code);
            } catch (error) {
                console.error("Failed to fetch weather:", error);
                applyWeatherTheme(null);
            }
        }

        function applyWeatherTheme(code) {
            const hour = new Date().getHours();
            const bodyClassList = document.body.classList;
            bodyClassList.forEach(cls => { if (cls.startsWith('weather-')) bodyClassList.remove(cls); });
            let themeClass = 'weather-default'; let animationType = null;
            if (code === null) {} 
            else if (code <= 1) { if (hour > 6 && hour < 15) { themeClass = 'weather-clear-day'; animationType = 'clear-day'; } else { themeClass = 'weather-clear-night'; animationType = 'clear-night'; } } 
            else if (code <= 3) { themeClass = 'weather-cloudy'; animationType = 'cloudy'; } 
            else if (code === 5 || code === 10 || code === 45 || code === 48) { themeClass = 'weather-haze-bg'; animationType = 'haze'; }
            else if (code >= 51 && code <= 82) { themeClass = 'weather-rain-bg'; animationType = 'rain'; } 
            else if (code >= 71 && code <= 77) { themeClass = 'weather-snow'; animationType = 'snow'; }
            bodyClassList.add(themeClass);
            startAnimation(animationType);
        }

        // --- User Management & UI ---
        function checkLoginState() {
            const userName = localStorage.getItem('userName');
            if (userName) {
                greetingHeader.textContent = `Welcome, ${userName}!`;
                welcomePage.classList.add('hidden');
                appPage.classList.remove('hidden');
            } else {
                welcomePage.classList.remove('hidden');
                appPage.classList.add('hidden');
            }
        }

        function handleNameSubmit(e) {
            e.preventDefault();
            const userName = nameInput.value.trim();
            if (userName) {
                localStorage.setItem('userName', userName);
                checkLoginState();
            }
        }

        const setDarkMode = (isDark) => {
            document.documentElement.classList.toggle('dark', isDark);
            sunIcon.classList.toggle('hidden', isDark);
            moonIcon.classList.toggle('hidden', !isDark);
        };

        const loadSettings = () => {
            const isDarkMode = localStorage.getItem('darkMode') !== 'false';
            setDarkMode(isDarkMode);
            fetchWeatherAndApplyTheme();
        };

        function loadTimetable() {
            const savedTimetable = localStorage.getItem('userTimetable');
            if (savedTimetable) {
                timetableInput.value = savedTimetable;
            } else {
                timetableInput.value = "Monday,02:35,03:00,maths,cl101";
            }
        }

        function saveTimetable() {
            const timetableData = timetableInput.value.trim();
            localStorage.setItem('userTimetable', timetableData);
            checkSchedule();
            saveConfirm.classList.remove('opacity-0');
            setTimeout(() => saveConfirm.classList.add('opacity-0'), 2000);
        }

        function parseTimetable(rawData) {
            if (!rawData) return [];
            return rawData.split('\n').map(line => {
                const [day, start, end, subject, room] = line.split(',').map(item => item.trim());
                if (day && start && end && subject && room) return { day, start, end, subject, room };
                return null;
            }).filter(Boolean);
        }

        function checkSchedule() {
            const now = new Date();
            const currentDay = days[now.getDay()];
            const currentTime = now.toTimeString().slice(0, 5);
            currentTimeDisplay.textContent = `Current Time: ${currentDay}, ${now.toLocaleTimeString()}`;
            const timetable = parseTimetable(localStorage.getItem('userTimetable'));
            if (timetable.length === 0) {
                currentClassDisplay.textContent = "No timetable saved.";
                studyTipBtn.classList.add('hidden');
                return;
            }

            currentClass = null;
            for (const cls of timetable) {
                if (cls.day.toLowerCase() === currentDay.toLowerCase() && currentTime >= cls.start && currentTime < cls.end) {
                    currentClass = cls;
                    break;
                }
            }
            
            if (currentClass) {
                if (!lastNotifiedClass || lastNotifiedClass.subject !== currentClass.subject || lastNotifiedClass.start !== currentClass.start) {
                    sendNotification(`${currentClass.subject} has started!`, `In Room: ${currentClass.room}`);
                    lastNotifiedClass = currentClass;
                }
                currentClassDisplay.innerHTML = `Ongoing: <span class="font-bold text-blue-600 dark:text-blue-400">${currentClass.subject}</span> in Room ${currentClass.room}`;
                studyTipBtn.classList.remove('hidden');
            } else {
                lastNotifiedClass = null;
                let nextClass = null;
                const sortedTodayClasses = timetable.filter(cls => cls.day.toLowerCase() === currentDay.toLowerCase()).sort((a, b) => a.start.localeCompare(b.start));
                for (const cls of sortedTodayClasses) {
                    if (cls.start > currentTime) {
                        nextClass = cls;
                        break;
                    }
                }
                if (nextClass) {
                    currentClassDisplay.innerHTML = `Next up: <span class="font-bold text-gray-700 dark:text-gray-300">${nextClass.subject}</span> at ${nextClass.start} in Room ${nextClass.room}`;
                } else {
                    currentClassDisplay.textContent = "No more classes today. Enjoy your break!";
                }
                studyTipBtn.classList.add('hidden');
            }
        }
        
        function populateDayButtons() {
            const weekDays = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
            daySelector.innerHTML = weekDays.map(day => 
                `<button data-day="${day}" class="day-btn px-3 py-1 border-2 border-gray-300 dark:border-gray-600 rounded-full text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700">${day}</button>`
            ).join('');
        }

        function displayDailySchedule(day) {
            document.querySelectorAll('.day-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.day === day);
            });

            const timetable = parseTimetable(localStorage.getItem('userTimetable'));
            const daySchedule = timetable.filter(cls => cls.day.toLowerCase() === day.toLowerCase()).sort((a, b) => a.start.localeCompare(b.start));

            if (daySchedule.length === 0) {
                dailyScheduleDisplay.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400">No classes scheduled for ${day}.</p>`;
                return;
            }

            dailyScheduleDisplay.innerHTML = `
                <ul class="space-y-3">
                    ${daySchedule.map(cls => `
                        <li class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                            <div>
                                <p class="font-semibold text-gray-800 dark:text-gray-100">${cls.subject}</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Room: ${cls.room}</p>
                            </div>
                            <p class="font-mono text-sm text-gray-600 dark:text-gray-300">${cls.start} - ${cls.end}</p>
                        </li>
                    `).join('')}
                </ul>
            `;
        }
        
        function requestNotificationPermission() {
            if (!("Notification" in window)) {
                alert("This browser does not support desktop notifications.");
                return;
            }
            if (Notification.permission !== "denied") {
                Notification.requestPermission().then(p => {
                    if (p === "granted") {
                        sendNotification("Notifications Enabled!", "You'll now get alerts when a class starts.");
                    }
                });
            }
        }

        function sendNotification(title, body = '') {
            if (Notification.permission === "granted") {
                new Notification(title, { body });
            }
        }


        async function getStudyTip() {
            if (!currentClass) return;
            toggleModal(true);
            modalBody.innerHTML = '<div class="loader mx-auto my-4"></div>';
            const prompt = `Provide a short, actionable study tip for the subject: ${currentClass.subject}. The tip should be easy to understand and apply immediately.`;
            try {
                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                const result = await response.json();
                if (result.candidates && result.candidates[0].content.parts[0].text) {
                    const text = result.candidates[0].content.parts[0].text;
                    modalBody.innerHTML = `<p>${text}</p>`;
                } else { throw new Error("Invalid response structure."); }
            } catch (error) {
                console.error("Gemini API Error:", error);
                modalBody.innerHTML = `<p class="text-red-500">Could not fetch a study tip. Please try again later.</p>`;
            }
        }

        function toggleModal(show) {
            if (show) {
                studyTipModal.classList.remove('opacity-0', 'pointer-events-none');
            } else {
                studyTipModal.classList.add('opacity-0', 'pointer-events-none');
            }
        }

        // --- Event Listeners ---
        nameForm.addEventListener('submit', handleNameSubmit);
        saveTimetableBtn.addEventListener('click', saveTimetable);
        darkModeToggle.addEventListener('click', () => { const isDark = document.documentElement.classList.toggle('dark'); localStorage.setItem('darkMode', isDark); });
        studyTipBtn.addEventListener('click', getStudyTip);
        modalCloseBtn.addEventListener('click', () => toggleModal(false));
        daySelector.addEventListener('click', (e) => {
            const dayBtn = e.target.closest('.day-btn');
            if (dayBtn) {
                displayDailySchedule(dayBtn.dataset.day);
            }
        });
        notifyBtn.addEventListener('click', requestNotificationPermission);
        
        // --- Initial Setup ---
        window.addEventListener('load', () => {
            checkLoginState();
            loadTimetable();
            loadSettings();
            populateDayButtons();
            checkSchedule();
            displayDailySchedule(days[new Date().getDay()]);
            setInterval(checkSchedule, 1000);
        });
    </script>
</body>
</html>
